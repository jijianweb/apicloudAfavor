<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>聊天-聊天列表</title>
		<link rel="stylesheet" href="../../css/api.css" />
		<link rel="stylesheet" href="../../css/ct.css" />
		<style type="text/css">
			html,
			body {
				height: 100%;
				width: 100%;
				background-color: transparent;
			}

			#text {
				padding: 0px 10px;
			}

			.seach {
				border: 1px solid #F3F3F3;
				border-radius: 25px;
				margin: 20px 18px 0 18px;
				background-color: #F3F3F3;
			}

			.se {
				width: 20px;
				height: 20px;
				margin-left: 10px;
				background-image: url(../../image/inbox/glass.png);
				background-repeat: no-repeat;
				background-position: center;
				background-size: 20px, 20px;
				padding: 9px 12px;
			}

			.search {
				width: 35px;
				height: 35px;
				background-image: url(../../image/inbox/search-white.png);
				background-repeat: no-repeat;
				background-position: center;
				background-size: cover;
			}

			.list-view {
				border-bottom: 2px solid #EEEEEE;
				line-height: 16px;
				position: relative;
			}

			.img {
				background-color: #CCCCCC;
				height: 60px;
				width: 60px;
				border: 1px solid #EEEEEE;
				border-radius: 50px;
				margin-right: 5px;
				/*background-image: url(../../image/inbox/photo-3.png);*/
				background-repeat: no-repeat;
				background-position: center;
				background-size: cover;

			}

			.content {
				font-size: 12px;
				margin-right: 50px;
			}

			.content-1 {
				font-size: 12px;
				padding-right: 50px;
				color: #949B9E;
			}

			.name {
				font-size: 16px;
				height: 17px;
			}

			.text-flow{
				display:-webkit-box!important;
				overflow:hidden;
				text-overflow:ellipsis;
				word-break:break-all;
				-webkit-box-orient:vertical;
				-webkit-line-clamp:1;
			}

			.name-1 {
				color: #949B9E;
				font-size: 16px;
			}

			.msg-num {
				width: 15px;
				height: 15px;
				border-radius: 50%;
				position: absolute;
				left: 21px;
				border: 1px solid #31BAB0;
				background-image: url(../../image/inbox/2.png);
				background-repeat: no-repeat;
				background-position: center;
				background-size: cover;
				top: 20px;
			}

			.list-view > .flex-1{
				height: 100%;
				padding-left: 10px;
			}

			.img-frm,
			.img{
				background-size: cover;
			}

			.sign{
				position: relative;
				color: #B4B4B4;
				font-size: 12px;
				/*height: 23px;*/
			}

			.datetime{
				font-size: 12px;
				line-height: 1.8;
				color: #aaa;
			}

			img.expression{
				position: relative;
				width: 20px;
				height: 20px;
				top: 5px;
			}
			#main{
				position: relative;
			}
			.null{
				top: 0;
			}

			.list-view .item{
				padding: 18px 18px 10px 18px;
				position: relative;
				background-color: #fff;
				z-index: 2;
				right: 0;
				transition: right .2s ease-out;
				-webkit-transition: right .2s ease-out;
			}
			.list-view .cancel-btn{
				position: absolute;
				right: 0;
				top: 0;
				color: #fff;
				height: 100%;
				width: 80px;
				z-index: 1;
				background-color: red;
			}
			.item.right-70{
				right: 80px;
			}
		</style>
	</head>

	<body>
		<div id="wrap" class="wrap">
			<div class="header" id="header">
				<div class="flex-box flex-v-ce seach">
					<div class="se"></div>
					<input type="text" lan="JumpToConversation" name="text" id="search" class="flex-1" oninput="searchInput(this)" placeholder="Jump to Conversation" />
					<div class="search" onclick="searchConversation()" tapmode></div>
				</div>
			</div>
			<div id="main" class="main">
				<div class="null hidden flex-box">
					<div class="flex-1">
						No content.
					</div>
				</div>

				<div class="list-view hidden" tapmode="" onclick="openGroup()">
					<div class="item flex-box flex-v-ce">
						<div class="img-frm">
							<div class="img" style="background-image: url();"></div>
							<div class="msg-num" style="background-image: url();"></div>
						</div>

						<div class="flex-1 flex-box-v flex-center-v">
							<div class="flex-box">
								<div class="flex-1 flex-box" style="padding-right: 10px;">
									<div class="name text-flow">
										你好你好你好你好你好你好你好你好你好你好你好你好你好
									</div>
									<div>
										<span class="ct-icon-type" style="font-size: 18px;"></span>
									</div>
								</div>
								<div class="datetime text-right">
									5月23日
								</div>
							</div>
							<div class="sign text-flow">
								你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好你好
							</div>
						</div>
					</div>

					<div class="cancel-btn flex-box flex-center-center">
						Supprimer
					</div>
				</div>

				<div class="list-view flex-box flex-v-ce hidden" tapmode="" onclick="openGroup()">
					<div class="img-frm">
						<div class="img" style="background-image: url();"></div>
						<div class="msg-num" style="background-image: url();"></div>
					</div>

					<div class="flex-1 flex-box-v flex-center-v">
						<div class="flex-box">
							<div class="flex-1 flex-box" style="padding-right: 10px;">
								<div class="name text-flow">
									weiweiweiweiweiweiweiwei
								</div>
								<div>
									<span class="ct-icon-type" style="font-size: 18px;"></span>
								</div>
							</div>
							<div class="datetime text-right">
								5月23日
							</div>
						</div>
						<div class="sign text-flow">
							犹犹豫豫哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈
						</div>
					</div>
				</div>

			</div>
		</div>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/doT.min.js"></script>
	<script type="text/javascript" src="../../script/common.js" ></script>
	<script type="text/javascript" src="../../script/rongCloud2.js" ></script>
	<script type="text/javascript" src="../../script/rongCloud_ps.js" ></script>
	<script type="text/javascript" src="../../script/UIChatBox.js" ></script>
	<script type="text/javascript" src="../../script/date.js" ></script>
	<script type="text/javascript" src="../../script/touch-0.2.14.min.js" ></script>
	<script type="text/javascript" src="../../script/echo.js"></script>
	<script type="text/javascript" src="../../res/language.js" ></script>
	<script type="text/template" template="main">
		{{ if(it instanceof Array && it.length!=0 && typeof it[0].latestMessage === 'object'){ }}
			{{~it :value:index }}
				{{? typeof value.latestMessage === 'object' }}
					{{? value.conversationType == 'PRIVATE'}}
					<!-- 单人聊天 -->
						{{? value.senderUserId === value.targetId}}
						<!-- 会话的最后一句是对方发出的 -->
							<div class="list-view" data-json="{{= encodeURIComponent(JSON.stringify(value)) }}" conversationType='{{= value.conversationType}}' favorid='{{= strToJson(value.latestMessage.extra).favorid}}' avatar="{{= strToJson(value.latestMessage.extra).mavatar}}" nickname='{{= strToJson(value.latestMessage.extra).mname}}' type='{{= strToJson(value.latestMessage.extra).type}}' inboxtype='{{= strToJson(value.latestMessage.extra).inboxtype}}' targetid="{{= value.targetId }}">
								<div class="item flex-box flex-v-ce">
									<div class="img-frm">
										<div class="img" style="background-image: url({{= Tool.imageCompressByQiNiu(strToJson(value.latestMessage.extra).mavatar,0,200,200)}});"></div>
										{{? value.unreadMessageCount}}
											<div class="msg-num" style="background-image: url(../../image/inbox/2.png);"></div>
										{{??}}
											<div class="msg-num hidden"></div>
										{{?}}
									</div>

									<div class="flex-1 flex-box-v flex-center-v">
										<div class="flex-box">
											<div class="flex-1 flex-box" style="padding-right: 10px;">
												<div class="name text-flow">
													<div class="flex-1 flex-box flex-h-ce name text-flow" mid="{{= strToJson(value.latestMessage.extra).memberid}}">
														{{= strToJson(value.latestMessage.extra).mname}}
													</div>
												</div>
											</div>
											<div class="datetime text-right">
												<!--{{= strToJson(value.latestMessage.extra).mname}}
												{{= strToJson(value.latestMessage.extra).memberid}}-->
												{{= D.t1(value.receivedTime, 1)}}
											</div>
										</div>
										<div class="sign text-flow" data-messageId="{{= value.latestMessageId }}">
											{{? value.draft}}
												[草稿]  {{= value.draft }}
											{{??}}
												{{= getLastMsgExt(value.targetId, value.latestMessageId, value.objectName, value.latestMessage.text, value.conversationType) || '' }}

												<!--{{? value.objectName == 'RC:TxtMsg' }}
													{{= h(value.latestMessage.text)||'' }}
												{{?? value.objectName == 'RC:VcMsg' }}
													[语音]
												{{??}}
													[图片]
												{{?}}-->
											{{?}}
										</div>
									</div>
								</div>
								<div lan="Delete" class="cancel-btn flex-box flex-center-center" onclick="deleteConversation(this, event)" tapmode="">
									Delete
								</div>
							</div>
						{{??}}
						<!-- 会话的最后一句是自己发出的 -->
							<div class="list-view" data-json="{{= encodeURIComponent(JSON.stringify(value)) }}" conversationType='{{= value.conversationType}}' favorid='{{= strToJson(value.latestMessage.extra).favorid}}' type='{{= strToJson(value.latestMessage.extra).type}}' inboxtype='{{= strToJson(value.latestMessage.extra).inboxtype}}' avatar="{{= strToJson(value.latestMessage.extra).avatar}}" nickname='{{= strToJson(value.latestMessage.extra).nickname}}' targetid="{{= value.targetId }}">
								<div class="item flex-box flex-v-ce">
									<div class="img-frm">
										<div class="img" style="background-image: url({{= Tool.imageCompressByQiNiu(strToJson(value.latestMessage.extra).avatar,0,200,200)}});"></div>
										{{? value.unreadMessageCount}}
											<div class="msg-num" style="background-image: url(../../image/inbox/2.png);"></div>
										{{??}}
											<div class="msg-num hidden"></div>
										{{?}}
									</div>

									<div class="flex-1 flex-box-v flex-center-v">
										<div class="flex-box">
											<div class="flex-1 flex-box" style="padding-right: 10px;">
												<div class="name text-flow">
													<div class="flex-1 flex-box flex-h-ce name text-flow" mid="{{= strToJson(value.latestMessage.extra).mid}}">{{= strToJson(value.latestMessage.extra).nickname}}</div>
												</div>
											</div>
											<div class="datetime text-right">
												{{= D.t1(value.receivedTime, 1)}}
											</div>
										</div>
										<div class="sign text-flow" data-messageId="{{= value.latestMessageId }}">
											{{? value.draft}}
												[草稿]  {{= value.draft }}
											{{??}}
												{{= getLastMsgExt(value.targetId, value.latestMessageId, value.objectName, value.latestMessage.text, value.conversationType) || '' }}

												<!--{{? value.objectName == 'RC:TxtMsg' }}
													{{= h(value.latestMessage.text)||'' }}
												{{?? value.objectName == 'RC:VcMsg' }}
													[语音]
												{{??}}
													[图片]
												{{?}}-->
											{{?}}
										</div>
									</div>
								</div>
								<div lan="Delete" class="cancel-btn flex-box flex-center-center" onclick="deleteConversation(this, event)" tapmode="">
									Delete
								</div>
							</div>
						{{?}}

						<!--<div>{{= value.latestMessage.extra}}</div>-->
					{{??}}
					<!-- 多人聊天 -->
						{{? value.latestMessage.extra}}
							<div class="list-view" data-json="{{= encodeURIComponent(JSON.stringify(value)) }}" conversationType='{{= value.conversationType}}' favorid='{{= strToJson(value.latestMessage.extra).favorid}}' nickname='{{= strToJson(value.latestMessage.extra).nickname}}' type='{{= strToJson(value.latestMessage.extra).type}}' inboxtype="1" targetid="{{= value.targetId }}">
								<div class="item flex-box flex-v-ce">
									<div class="img-frm">
										<div class="img" style="background-image: url({{= Tool.imageCompressByQiNiu(strToJson(value.latestMessage.extra).postAvatar,0,200,200)}});"></div>
										{{? value.unreadMessageCount}}
										<div class="msg-num" style="background-image: url(../../image/inbox/2.png);"></div>
									{{??}}
										<div class="msg-num hidden"></div>
									{{?}}
									</div>

									<div class="flex-1 flex-box-v flex-center-v">
										<div class="flex-box">
											<div class="flex-1 flex-box" style="padding-right: 10px;">
												<div class="name text-flow">
													<div class="flex-1 flex-box flex-h-ce name text-flow" mid="{{= strToJson(value.latestMessage.extra).mid}}">
														Group
													</div>
												</div>
											</div>
											<div class="datetime text-right">
												{{= D.t1(value.receivedTime, 1)}}
											</div>
										</div>
										<div class="sign text-flow" data-messageId="{{= value.latestMessageId }}">
											{{? value.draft}}
												[草稿]  {{= value.draft }}
											{{??}}
												{{= getLastMsgExt(value.targetId, value.latestMessageId, value.objectName, value.latestMessage.text,value.conversationType) || '' }}

												<!--{{? value.objectName == 'RC:TxtMsg' }}
													{{= h(value.latestMessage.text)||'' }}
												{{?? value.objectName == 'RC:VcMsg' }}
													[语音]
												{{??}}
													[图片]
												{{?}}-->
											{{?}}
										</div>
									</div>
								</div>
								<div lan="Delete" class="cancel-btn flex-box flex-center-center" onclick="deleteConversation(this, event)" tapmode="">
									Delete
								</div>
							</div>
						{{?}}
					{{?}}
				{{?}}
			{{~}}
		{{ }else{ }}
			<div class="null flex-box">
				<div class="flex-1" lan="There_is_no_content">
					 No content
				</div>
			</div>
		{{ } }}
	</script>
	<script type="text/javascript">
		function strToJson(value){
			var str = JSON.parse(value);
			return str;
		}

		function openTalkWith(_this, targetId){
			var jsonData = JSON.parse(decodeURIComponent($api.attr(_this, 'data-json'))),
				extra = JSON.parse(jsonData.latestMessage.extra),
				targetId = jsonData.targetId,
				favorid = extra.favorid,
				memberInfo = $api.getStorage(CONFIG.KEY.MEMBER_INFO),
				mid = $api.getStorage(CONFIG.KEY.MEMBER_ID),
				conversationType = jsonData.conversationType,
				inboxtype = extra.inboxtype,	//区分单聊(2)、群聊(1)
				postId = extra.postId,
				nickname,	//两种情况，群聊：Group；单聊：对方昵称
				avatar,
				pname,	//发布者昵称
				type = mid == postId ? 2 : 1;	//当前用户身份,1:帮助者，2:发布者


			if(jsonData.targetId == jsonData.senderUserId){
				//会话的最后一句是对方发出的
				nickname = extra.mname;
				avatar = extra.mavatar;
				if(postId == targetId){
					pname = nickname;
				}else{
					pname = extra.nickname;
				}
			}else{
				//会话的最后一句是自己发出的
				avatar = extra.avatar;
				nickname = extra.nickname;
				if(postId == targetId){
					pname = nickname;
				}else{
					pname = extra.mname;
				}
			}


			//TODO 打开聊天页面
			api.openWin({
				name: 'talk_with',
				url: api.wgtRootDir + '/html/window/talk_with.html',
				pageParam: {
					chatIds: extra.chatIds,
					groupId: extra.groupId,
					pid: postId,	//发布者id
					pnmae: pname,	//发布者昵称
					pavatar: extra.postAvatar, //发布者头像
					mavatar: memberInfo.avatar,	//当前用户头像
					targetNickname: nickname,	//两种情况，群聊：Group；单聊：对方昵称
					targetId: targetId,	//两种情况，群聊：任务id；单聊：对方id
					favorid: favorid,	//任务id
					avatar: avatar,		//单聊, 对方头像, 发布者头像或帮助者头像
					conversationType: conversationType,
					type: type,	//当前用户身份,1:帮助者，2:发布者
					inboxtype: inboxtype	//区分单聊(2)、群聊(1)
				},
				bounces: false,
				bgColor: '#fff',
				slidBackEnabled: false
			});
		}
		function h(str){
			if(str){
				var regx = /(\&[l,g]t;)|(api.wgtRootDir)/gm,
					_html = str.replace(regx, function(match){
						switch(match){
							case '&lt;':
								return '<';
							case '&gt;':
								return '>';
							case 'api.wgtRootDir':
								return '../..';
						}
					});
				return _html;
			}else{
				return '';
			}
		}
		function reload(){
			var searchDOM = $api.dom('input#search');
			$api.val(searchDOM, '');
			RongCloud2.getConversationList(function(result){
				console.log('inbox列表：---------' + JSON.stringify(result,null,2));
				T.html('#main', 'main', result);
				L.init();
//				console.log(JSON.stringify(result,null,2))
//				setTimeout(function(){
//			          api.refreshHeaderLoadDone()
//			    }, 100);

			});
		}

		function searchInput(_this){
			var val = $api.val(_this);
			if(!val){
				reload();
			}
		}

		//获取最新一条信息内容，显示于列表
		function getLastMsgExt(targetId,latestMessageId, objectName, _text, type) {
			RongCloud2.getLatestMessages({
				conversationType: type,
				targetId: targetId,
				count: 1
			}, function(result){
				var lIdDom = $api.dom('[data-messageId="'+latestMessageId+'"]');
				var msg = '';
				switch(objectName){
					case 'RC:TxtMsg':
						msg = h(_text) || '';
						$api.html(lIdDom, msg);
					break;
					default:
						for(var i=0;i<result.length;i++){
							if(result[i].content.extra && JSON.parse(result[i].content.extra).type == 'gift'){
								msg = '[gift]';
							}else{
								msg = '[image]';
							}
						}
						$api.text(lIdDom, msg);
					break;
				}

			});
		}

		//监听命令消息，设置本地消息附加信息，保存于本地
		function setMsgExtra(targetId, value) {
			RongCloud2.getLatestMessages({
				targetId: targetId,
				count: 50
			}, function(result){
				var data = JSON.parse(value.content.data),
						msgTime = data.msgTime;
				for(var i=0;i<result.length;i++) {
					var content = result[i].content;
					var g = JSON.parse(content.extra).msgTime;
					if(g == msgTime) {
						var messageId = result[i].messageId;
//						alert(messageId +','+ typeof messageId +','+ typeof parseInt(messageId))
						RongCloud2.setMessageExtra({
							messageId: parseInt(messageId),
							value: '{\"msgTime\": "'+g+'",\"type\": "recallMsg"}',
							success: function(ret) {
								console.log('对方撤回一条信息成功');
							}
						});
						return;
					}
				}
			});
		}
		function searchConversation(){
			var searchDOM = $api.dom('input#search'),
				keyword = $api.trimAll($api.val(searchDOM));
			var rong = api.require('rongCloud2'),
				_arr = [],
				reg = new RegExp(keyword);

			searchDOM.blur();

			rong.getConversationList(function(ret){
				if(ret.status){
					ret.result.forEach(function(value, index){
						var extra = JSON.parse(value.latestMessage.extra);
						if(reg.test(extra.nickname)){
							console.log(1)
							_arr.push(value);
						}
						console.log(JSON.stringify(_arr))
					});
					T.html('#main', 'main', _arr);
				}
			});
		}

		function deleteConversation(_this, e){
			var listViewDOM = $api.closest(_this, '.list-view'),
				jsonData = JSON.parse(decodeURIComponent($api.attr(listViewDOM, 'data-json'))),
				conversationType = jsonData.conversationType,
				targetId = jsonData.targetId;
			e.stopPropagation();

			RongCloud2.removeConversation({
				targetId: targetId,
				conversationType: conversationType,
				success: function(){
					$api.remove(listViewDOM);
					if($api.domAll('#main > div').length == 0){
						T.html('#main', 'main', []);
					}
				}
			});
		}

		apiready = function(){
			reload();
			//在#main下注册节点变动事件
			$api.addEvt($api.dom('#main'), 'DOMNodeInserted', function(e){
				if(e.target.nodeType === 1 && $api.hasCls(e.target, 'list-view')){
					touch.on(e.target, 'hold click swipeleft swiperight', function(evt){
						var targetId = $api.attr(e.target, 'targetid'),
							activeItem = $api.dom('.item.right-70'),
							_dom = $api.dom(e.target, '.item'),
							conversationType = $api.attr(e.target,'conversationType'),
							buttons, notificationStatus;
//							Debug.alt(JSON.stringify(conversationType));
						switch(evt.type){
							case 'swipeleft':
								if(activeItem != _dom){
									$api.removeCls(activeItem, 'right-70');
								}
								$api.addCls(_dom, 'right-70');
								break;
							case 'swiperight':
								$api.removeCls(_dom, 'right-70');
								break;
							case 'click':
								openTalkWith(e.target, targetId);
								break;
						}
					});
				};
			});
			
			
			//TODO: 任务完成时，删除聊天入口
			RongCloud2.closeChatEntrance();

			//刷新聊天消息列表
			api.addEventListener({
				name: 'viewappear'
			}, function(ret, err){
				reload();
			});

			/*标记会话为未读*/
			api.addEventListener({
				name: 'newMessage'
			}, function(ret, err){
				if(ret.value && ret.value.message){
					var value = ret.value.message,
						conversationDoms = $api.domAll('[targetid]'),
						conversationDom = $api.dom('[targetid="'+ value.targetId +'"]'),
						conversationDomCopy,
						msgNumDom, msgNum, nullDom, messageDom;
				}else{
					return;
				}


				//console.log(JSON.stringify(value))
//				Debug.alt(JSON.stringify(value,null,2))
				if(conversationDom){
					//已存在会话
					msgNumDom = $api.dom(conversationDom, '.msg-num');
					msgNum = parseInt($api.text(msgNumDom));
					messageDom = $api.dom(conversationDom, '.sign');
					switch(value.objectName){
						case 'RC:TxtMsg':
							$api.html(messageDom, h(value.content.text));
							break;
						case 'RC:ImgMsg':
							$api.html(messageDom, '[图片]');
							break;
						case 'RC:VcMsg':
							$api.html(messageDom, '[语音]');
							break;
						case 'RC:CmdMsg':
							$api.html(messageDom, "'" + value.targetId + "'" + '  撤回了一条信息');
							setMsgExtra(value.targetId, value);
							break;
					}

					$api.text($api.dom(conversationDom, '.datetime'), D.t1(value.receivedTime, 1));
					if($api.hasCls(msgNumDom, 'hidden')){
						$api.removeCls(msgNumDom, 'hidden');
					}else{
//						$api.text(msgNumDom, msgNum+1);
					}

					/*会话置顶*/
					var flag = conversationDoms[0] === conversationDom
//					alert($api.attr(conversationDoms[0], 'targetid') + ':'+ value.targetId);
//					$api.dom('#main').appendChild(conversationDomCopy)

					if(!flag){
						conversationDomCopy = conversationDom.cloneNode(true);
						$api.remove(conversationDom);
						$api.dom('#main').insertBefore(conversationDomCopy, conversationDoms[0])
					}
				}else{
					//若存在"加载中..."遮罩层，则去除
					nullDom = $api.dom('.null');
					//调整数据结构，以适配模板
					value.latestMessage = value.content;

					if(nullDom){
						$api.remove(nullDom);
					}
					T.prepend('#main', 'main', [value]);
					//显示未读红点
					var _dom = $api.dom('#main > div:first-child');
					_dom = $api.dom(_dom, '.msg-num');
					$api.removeCls(_dom, 'hidden');
				}
			});

			//标注该会话为已读
			api.addEventListener({
				name: 'clearMessagesUnreadStatus'
			}, function(ret, err){
				var conversationDom = $api.dom('[targetid="'+ ret.value.targetId +'"]'),
						msgNumDom, messageId, messageDom;
				if(conversationDom){
					//清除未读红点
					msgNumDom = $api.dom(conversationDom, '.msg-num');
					if(!$api.hasCls(msgNumDom, 'hidden')){
						RongCloud2.clearMessagesUnreadStatus({
							conversationType: ret.value.type,
							targetId: ret.value.targetId,
							success: function(){
								//未读条数清零
//								$api.text(msgNumDom, 0);
								$api.addCls(msgNumDom, 'hidden');
							}
						});
					}

					/* 更新该会话最近一次的消息内容
					 * 分两种情况：新消息、用户主动删除消息
					 */
					messageDom = $api.dom(conversationDom, '.sign');
					messageId = $api.attr(messageDom, 'data-messageId');
//					Debug.alt(ret.value.targetId)
					RongCloud2.getConversation({
						conversationType: ret.value.type,
						targetId: ret.value.targetId,
						success: function(result){
							if(messageId != result.latestMessageId){
								//更新消息发送时间
								$api.text($api.dom(conversationDom, '.datetime'), D.t2(result.receivedTime, 1));
								switch(result.objectName){
									case 'RC:TxtMsg':
										$api.html(messageDom, h(result.latestMessage.text));
										break;
									case 'RC:ImgMsg':
										$api.html(messageDom, '[图片]');
										break;
									case 'RC:VcMsg':
										$api.html(messageDom, '[语音]');
										break;
								}
							}
						}
					});
				}
			});

			//保存某一会话的文字消息草稿
			api.addEventListener({
				name: 'setTextMessageDraft'
			}, function(ret, err) {
				api.closeWin({
					name: 'TalkWith'
				});

				if(ret && ret.value) {
					var conversationDom = $api.dom('[targetid="'+ ret.value.targetId +'"]'),
							msgNumDom, messageId, messageDom,
							txt = ret.value.txt,
							targetId = ret.value.targetId;

					if(!conversationDom) return;

					messageDom = $api.dom(conversationDom, '.sign');

					if(txt) {
						$api.text(messageDom, '[草稿]   ' + h(txt));
						RongCloud2.saveTextMessageDraft({
							targetId: targetId,
							content: txt
						});
					}else {
						RongCloud2.clearTextMessageDraft({
							targetId: targetId
						}, function() {});
					}
				}
			});
		}
	</script>

</html>
