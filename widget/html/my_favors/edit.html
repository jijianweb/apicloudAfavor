<!doctype html>
<html lang="en">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no">
		<title>我的任务-我发布的任务 -任务详情-编辑(已经有帮助者)</title>
		<link rel="stylesheet" type="text/css" href="../../css/ct.css" />
		<style type="text/css">
			#wrap {
				padding: 20px 18px 0;
			}
			
			.date {
				padding: 10px 15px 9px 20px;
				border: 1px solid #828B90;
				border-radius: 25px;
				color: #000000;
				width: 100%;
				font-size: 12px;
			}
			
			.square {
				background-position: center;
				background-image: url(../../image/post/xiala.png);
				background-size: 12px 6px;
				background-repeat: no-repeat;
				width: 12px;
				height: 8px;
			}
			
			input[type="date"]::-webkit-calendar-picker-indicator {
				-webkit-appearance: none !important;
				margin: 0;
				width: 100%;
				position: relative;
				opacity: 0;
				z-index: 999;
				display: block;
			}
			
			input[type='date'] {
				-moz-appearance: textfield;
				-webkit-appearance: none;
				width: 100%;
				color: #000000;
			}
			
			.text {
				color: #ABAFB1;
				font-size: 14px;
				padding: 0 10px 6px 22px;
				margin-top: 48px;
			}
			
			.eh {
				margin-bottom: 12px;
				color: #828B8F;
				width: 100%;
				font-size: 18px;
				text-align: center;
			}
			
			.money {
				border: 1px solid #828B90;
				border-radius: 10px;
				font-size: 50px;
				width: 171px;
				height: 74px;
				line-height: 74px;
			}
			
			.prices1 {
				width: 86px;
				color: #000000;
				padding-left: 15px;
				text-align: center;
			}
			.tprice {
				width: 171px;
			}
			
			.price {
				color: #BDC3C8;
				text-align: center;
				margin-left: 5px;
			}
			.up-down {
				background-size: 15px 15px;
				background-repeat: no-repeat;
				background-position: center;
				background-image: url(../../image/Shape-1.png);
				width: 20px;
				height: 20px;
			}
			
			.sub {
				background-color: #32BBB1;
				border-radius: 25px;
				text-align: center;
				color: white;
				margin-bottom: 16px;
			}
			
			/*hourly 的价格编辑*/
			
			.hmoney,
			.hhour {
				border: 1px solid #babfc1;
				border-radius: 13px;
				width: 154px;
				height: 67px;
				line-height: 67px;
				font-size: 36px;
			}
			
			.hmoney {
				margin-left: 12px;
			}
			.prices1::-webkit-input-placeholder {
				color: #BDC3C8;
			}
			.currency,
			.htime,
			.pr3::-webkit-input-placeholder {
				color: #BDC3C8;
			}
			
			.pr2::-webkit-input-placeholder {
				color: #BDC3C8;
			}
			
			.pr1 {
				color: #BDC3C8;
				width: 56px;
			}
			
			.pr2 {
				width:95px;
				text-align:right;
				padding:0 10px 0 10px;
				color: #000000;
			}
			/*hourly 的金额*/
			.hmoney {
			  padding: 0 10px;		
			}
			.currency {
				color: #BDC3C8;
				position: relative;
			}
			
			.pr3 {
				text-align: center;
				width:65px;
			}
			/*hourly end*/
		</style>
	</head>

	<body>
		<div id="wrap">
			<div id="main">
				<div class="list ">
					<div class="hourly hidden">
						<div class="flex-box ">
							<div class="eh ">Hourly</div>
							<div class="up-down" onclick="changeMoeny()" tapmode></div>
						</div>
						<div class="flex-box flex-center-center">
							<div class="hhour flex-box">
								<input class="pr2 " type="number" placeholder="0.0" />
								<span class="pr1 flex-1">hr</span>
							</div>
							<div class="hmoney flex-box">
								<span class="currency">C$</span>
								<input class="pr3 " type="number" placeholder="0.0" />
								<span class="htime">/h</span>
							</div>
						</div>
					</div>
					<div class="total ">
						<div class="flex-box ">
							<div class="eh flex-1">Total Fix Price</div>
							<div class="up-down" onclick="changeMoeny()" tapmode></div>
						</div>
						<div class="tprice" style="margin:  0 auto;">
							<div class="flex-box money flex-h-zhu">
								<div class="price">C$</div>
								<div >
									<input class="prices1" type="number" id="money" placeholder="0.0"/>
								</div>
							</div>
						</div>
					</div>
					<div class="flex-box flex-center-center" style="padding:0px 15px;margin-top:13px;">
						<div class="" style="color:#ABAFB1;font-size: 12px;">Estimated Budget</div>
						<div class="" style="font-size: 20px;margin-left: 12px;">$0/ Person</div>
					</div>
					<div class="text">Due Date</div>
					<div class="date flex-box flex-center-center">
						<input class="flex-1" type="date" readonly="readonly" id="offDate" onclick="setTime()" tapmode="" />
						<span class="square"></span>
					</div>
				</div>
			</div>
			<div class="sub btn-afavor-1" lan="SAVE" style="margin-top: 150px;" onclick="save()" tapmode="">SAVE</div>
		</div>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/doT.min.js"></script>
	<script type="text/javascript" src="../../script/common.js"></script>
	<script type="text/javascript" src="../../res/language.js"></script>
	<script src="../../script/font.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/template" template="main">
		<div class="list">
			<div class="hourly {{? it.ishours==0}}hidden{{?}}">
				<div class="flex-box ">
					<div class="eh flex-1" lan="Hourly">Hourly</div>
					<div class="up-down" onclick="changeMoeny()" tapmode></div>
				</div>
				<div class="flex-box flex-center-center">
					<div class="hhour flex-box">
						<input class="pr2" placeholder="0.0" type="number" placeholder="0.0" {{? it.ishours==1}}value="{{=it.hourly}}" {{?}} id="time" oninput="wayTwo()" tapmode="" />
						<span class="pr1 flex-1">hr</span>
					</div>
					<div class="hmoney flex-box">
						<span class="currency">{{=it.default_currency == 'cad' ? 'C$' : '$'}}</span>
						<span>
							<input class="pr3 " placeholder="0.0" id="cash" type="number" oninput="wayTwo()" tapmode="" {{? it.ishours==1}}value="{{=parseFloat(it.remuneration1)}}" {{?}}/>
						</span>
						<span class="htime">/h</span>
					</div>
				</div>
			</div>
			<div class="total {{? it.ishours==1}}hidden{{?}}">
				<div class="flex-box ">
					<div class="eh flex-1" lan="TotalFixPrice">Total Fix Price</div>
					<div class="up-down" onclick="changeMoeny()" tapmode></div>
				</div>
				
				<div class="tprice" style="margin:  0 auto;">
					<div class="flex-box money flex-h-zhu">
						<div class="price">{{=it.default_currency == 'cad' ? 'C$' : '$'}}</div>
						<div class="">
							<input class="prices1" placeholder="0.0" type="number" id="money" {{? it.ishours==0}}value="{{=parseFloat(it.remuneration)}}" {{?}} oninput="wayOne()" tapmode="" />
						</div>
					</div>
				</div>
			</div>
			<div class="flex-box flex-center-center" style="padding:0px 15px; margin-top:13px;">
				<div class="" style="color:#ABAFB1;font-size: 12px;" lan="EstimatedBudget">Estimated Budget</div>
				<div class="" style="font-size:20px;margin-left: 12px;">
					{{=it.default_currency == 'cad' ? 'C$' : '$'}}
					<span id="everyOne">{{=it.budget || '0'}}</span> /
					<span lan="Person" style="color: inherit;">Person</span>
				</div>
			</div>
			<div class="text" lan="DueDate">Due Date</div>
			<div class="date flex-box flex-center-center" onclick="setTime()" tapmode="">
				<input class="flex-1" type="text" readonly="readonly" placeholder="" id="offDate" value="{{=duedate}}" />
				<span class="square"></span>
			</div>
		</div>

	</script>
	<script type="text/javascript">
		var favorid = "";
		var wokers = "",
			remuneration1 = '', //每小时多少钱
			hourly = '', //每小时
			remuneration = '', //金额
			duedate = '', //截止日期
			budget = ''; //每人多少钱
			var day;
		apiready = function() {
			favorid = api.pageParam.favorid;
			var isdue= api.pageParam.isdue;
			if(isdue==1){
				$api.attr($api.dom('.sub'),'lan','REPOST');
				$api.text($api.dom('.sub'),LANGUAGE[$api.getStorage('lan')]['REPOST']);
			}
			init();
		}
       
		function init() {
			ajax.get({
				ctrl: 'Favor',
				fn: 'getFavorDetails',
				data: {
					values: {
						id: $api.getStorage(CONFIG.KEY.MEMBER_ID),
						token: $api.getStorage(CONFIG.KEY.TOKEN),
						favorid: favorid
					}
				},
				showError: true,
				showProgress: true,
				hideLoading: true,
				success: function(ct) {
					    day = ct.duedate;
					var due1 = day.substring(0, 4),
						due2 = day.substring(5, 7),
						due3 = day.substring(8, 10)
					duedate = due3 + '-' + due2 + '-' + due1;
					T.html('#main', 'main', ct);
					var lengths =parseInt(ct.remuneration.length),
			            timelength=parseInt(ct.hourly.length),
			            moenylength=parseInt(ct.remuneration1.length);
			        var ishours=ct.ishours;
					wokers = ct.workers;
					remuneration = ct.remuneration;
					hourly = ct.hourly;
					remuneration1 = ct.remuneration1;
					budget = ct.budget;
				    if(ishours==0){
			        	wayOneLength1(lengths,remuneration)
			        }else{
			        	wayTwoLength1(timelength,moenylength,remuneration1)
			        }
			        	L.init();
				}
			});
		}
		//价格的编辑
		function changeMoeny() {
			$api.toggleCls($api.dom('.total'), 'hidden');
			$api.toggleCls($api.dom('.hourly'), 'hidden');
		}
		//总金额
		var money = ''
		//每人多少钱
		function wayOne() {
			var pay = 0,
				money = $api.val($api.dom('#money'));
			if(money == 0) {
				money = $api.val($api.dom('#money'), '');
			}
			var length =parseInt(money.length)
			wayOneLength(length)
			$api.val($api.dom('#cash'), ' ')
			$api.val($api.dom('#time'), ' ')
			if(money == '' || remuneration == '') {
				pay = budget;
			} else {
				pay = money / wokers;
			}
			$api.text($api.dom('#everyOne'), pay >= 0 ? pay.toFixed(2) : 0);

		}
		//按小时
		var cash = '',
			time;

		function wayTwo() {
			//每小时的金额
			cash = $api.val($api.dom('#cash'));
			//小时
			time = $api.val($api.dom('#time'));
			var timelength = parseInt(time.length);
			var moenylength = parseInt(cash.length);
			
			wayTwoLength(timelength,moenylength)
			
			$api.val($api.dom('#money'), ' ')
			if(cash == 0 && time == 0) {
				cash = $api.val($api.dom('#cash'), '');
				//小时
				time = $api.val($api.dom('#time'), '');
			}
			var hPrice = 0;
			if(cash == '' && time != '') {
				hPrice = remuneration1 * time / wokers;
			} else if(cash != '' && time == '') {
				hPrice = hourly * cash / wokers;
			} else if(cash == '' && time == '') {
				hPrice = budget;
			} else {
				hPrice = cash * time / wokers;
			}
			$api.text($api.dom('#everyOne'), hPrice >= 0 ? hPrice.toFixed(2) : 0);
		}

		//选择时间
		//选择时间
		function setTime() {
			inputBlur(); //将键盘收下来
			var nows = new Date(),
				_year = nows.getFullYear(),
				_month = nows.getMonth() + 1,
				_day = nows.getDate();

			_month = _month > 9 ? _month : '0' + _month;
			_day = _day > 9 ? _day : '0' + _day;
			nows = new Date(_year + '-' + _month + '-' + _day).getTime();
			api.openPicker({                
					type: 'date',
					date: 'date',
					title: 'Select the date'            
				},
				function(ret, err) {  
					var daytime=day.replace(/-/g,'/');
					    daytime=new Date(daytime).getTime();
					if(ret) {
						var value = ret,
							y = value.year,
							m = value.month > 9 ? value.month : '0' + value.month,
							d = value.day > 9 ? value.day : '0' + value.day,
							time = y + '-' + m + '-' + d,
							dateTime = new Date(time).getTime();
						if(dateTime < nows) {
							Tool.toast('Cannot choose the past date.');
							return
						}else if(daytime>dateTime) { //判断时间不能晚于当前的时间
							Tool.toast('The due date cannot be earlier than ' + duedate + '.');
							return;
						}else {
							if(value.year==1970){
								$api.val($api.dom('#offDate'),duedate);
							}else{
								$api.val($api.dom('#offDate'), d + '-' + m + '-' + y); 
							}
						} 
					}            
				});     
		}

		//保存
		function save() {
			money = $api.val($api.dom('#money'));
			var due = $api.val($api.dom('#offDate'));
			var due1 = due.substring(0, 2),
				due2 = due.substring(3, 5),
				due3 = due.substring(6, 10)
			var datechage = due3 + '-' + due2 + '-' + due1; //转换后的日期
			//每小时的金额
			cash = $api.val($api.dom('#cash'));
			//小时
			time = $api.val($api.dom('#time'));
			//ishours是否按小时收费,0为否，1为是
			var ishours;
			if(money == 0) {
				if((remuneration>(time * cash ))&&(remuneration!=(time * cash )) || ((hourly * remuneration1)>(time * cash) )   ) {
					Tool.toast('The price should not be lower than the original price.');
					return;
				}
				ishours = 1
			} else {
				if(parseFloat(remuneration)>money ||((hourly * remuneration1)>money && (hourly * remuneration1)!=money)) {
					Tool.toast('The price should not be lower than the original price.');
					return;
				}
				ishours = 0
			}
			var isadd = 1 //是否加钱,1:不是,2:是
			if(parseFloat(money) > parseFloat(remuneration) || (time * cash > hourly * remuneration1 )) {
				isadd = 2
			}else {
				isadd = 1;
			}
			ajax.get({
				ctrl: 'Favor',
				fn: 'editFavor',
				data: {
					values: {
						id: $api.getStorage(CONFIG.KEY.MEMBER_ID),
						token: $api.getStorage(CONFIG.KEY.TOKEN),
						favorid: favorid,
						remuneration1: cash == '' ? remuneration1 : cash,
						hourly: time == '' ? hourly : time,
						remuneration: money == '' ? remuneration : money,
						duedate: datechage,
						isadd: isadd,
						ishours: ishours
					}
				},
				showError: true,
				showProgress: true,
				hideLoading: true,
				success: function(ct) {
//					T.html('#main', 'main', ct);
					//设置编辑的缓存
//					var editData = ct;
//					$api.setStorage('editData', editData);
					api.execScript({
						name: 'task_detail',
						frameName: 'my_task_detail',
						script: 'init()'
					});
					api.execScript({
						name: 'Init',
						frameName: 'more',
						script: 'init()'
					});
					var editType = 0
					if(isadd == 1) {
						//不加钱
						api.execScript({
							name: 'Init',
							frameName: 'browse_list',
							script: 'TaskList()'
						});
						api.execScript({
							name: 'task_detail',
							frameName: 'my_task_detail',
							script: 'init()'
						});
						api.execScript({
							name: 'Init',
							frameName: 'my_promulgator',
							script: 'init()'
						});

					} else if(isadd == 2) {
						//加钱
//						api.openWin({
//							name: 'publish',
//							url: api.wgtRootDir + '/html/window/publish.html',
//							pageParam: {
//								frameName: 'fourth_step',
//								frameUrl: api.wgtRootDir + '/html/post/fourth_step.html',
//								frameParam: {
//									editType: editType
//								},
//								headerTitle: LANGUAGE[$api.getStorage('lan')]['Make_A_Favor'],
//							},
//							reload: true,
//							slidBackEnabled: false,
//						});
					}
					
					setTimeout(function() {
						api.closeWin({});
					}, 300);
				}
			});
		}
	</script>

</html>