<!doctype html>
<html lang="en">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no">
		<title>添加信用卡详情</title>
		<link rel="stylesheet" type="text/css" href="../../css/ct.css" />
		<style type="text/css">
			#main {
				padding: 20px 18px 0;
			}
			
			input[type="month"],
			input[type="text"],
			input[type="number"],
			.value_text {
				outline: none;
				resize: none;
				border: 1px solid #CCCCCC;
				border-radius: 25px;
				color: #BCC1C3;
				width: 100%;
			}
			
			.sel-bor {
				border: 1px solid #CCCCCC;
				border-radius: 25px;
				width: 100%;
			}
			input[type="month"] {
				margin-bottom: 10px;
				padding:2px 11px 0px 16px;
				height: 45px;
			}
			.sel {
				color: #BCC1C3;
				outline: none;
				resize: none;
				padding: 10px 0px 10px 10px;
				width: 95%;
				border: none;
				appearance: none;
				-moz-appearance: none;
				-webkit-appearance: none;
				background: url(../../image/down.png)no-repeat scroll right center transparent;
				background-size: 13px 8px;
			}
			
			input[type="password"],
			input[type="text"],
			input[type="number"],
			.value_text {
				padding: 10px 10px 10px 15px;
				margin-bottom: 10px;
				color: #BCC1C3;
			}
			.text {
				color: #858B8B;
				font-size: 14px;
				padding: 15px 0px 5px 14px;
			}
			.foot{
            	padding:45px 0px 16px;
            	width:100%;
            }
			.save {
				background-color: #32BBB1;
				border-radius: 25px;
				text-align: center;
				color: white;
			}
			
			.cirlce {
				width: 50px;
				height: 50px;
				background-image: url(../../image/post/lock.png);
				background-size:contain;
				background-repeat: no-repeat;
				background-position: center;
				margin: 0 auto;
			}
			
			.bom-t {
				text-align: center;
				color: #D7D8DA;
				font-size: 12px;
				padding-top: 10px;
				width: 210px;
				margin: 0 auto;
			}
			.card {
				font-size: 12px;
				color: #858B8B;
				text-align: right;
				padding: 6px 5px 0px 0;
			}
			
			.btn-card-close {
				background-image: url(../../image/close.png);
				width: 50px;
				height: 29px;
			}
			
			.btn-card-close,
			.btn-card {
				background-position: center;
				background-repeat: no-repeat;
				background-size:contain;
			}
			
			.btn-card {
				background-image: url(../../image/post/save.png);
				width: 50px;
				height: 29px;
			}
			/*样式调整2017-11-5*/
			input[type="text"],
			.value_text{
				padding: 13px 22px 13px;
				font-size: 14px;
				margin-bottom:15px;
			}
			.text{
				padding-bottom: 9px;
				padding-left: 22px;
			}
			#main{
				padding-top: 22px;
			}
			.sel{
				padding: 13px 22px;
				font-size: 14px;
				
			}
			/*华为按钮调整*/
			@media (max-height:400px){
				.save{
					display: none;
				}
			}			
		</style>
	</head>

	<body>
		<div id="wrap">
			<div id="main">
				<div>
					<span class="text" lan="Name">Name</span>
					<!-- JIANWEI FAN -->
					<input type="text" placeholder="" id="name" value="" />
				</div>
				<div>
					<span class="text" lan="Card_number">Card number</span>
					<input type="number" placeholder="" id="number" value="" type="text" onkeypress="return event.keyCode>=48&&event.keyCode<=57" oninput="value=value.replace(/[^\d]/g,'') " />
				</div>
				<div class="flex-box" style="margin-top:6px;">
					<div class="flex-1">
						<div class="text" lan="ExpireDate">Expire Date</div>
						<input type="month" id="expire" />
					</div>
					<div class="flex-1" style="margin-left: 15px;">
						<div class="text" lan="SecurityCode">Security Code</div>
						<input id="securityCode" value="" type="text" onkeypress="return event.keyCode>=48&&event.keyCode<=57" oninput="value=value.replace(/[^\d]/g,'') " />
					</div>
				</div>
				<div>
					<span class="text" lan="StreetAddress">Street Address</span>
					<!-- 9 Chillwood Crt -->
					<input type="text" id="address" value="" />
				</div>
				<div>
					<span class="text" lan="City">City</span>
					<div id="city" class="value_text" onclick="openCitySelector()" tapmode>
						<!--{{= curCity.city.name || '&nbsp;'}}-->&nbsp;
					</div>
				</div>

				<div class="flex-box">
					<div class="flex-1">
						<div class="text" lan="Province">Province</div>
						<div class="sel-bor">
							<div id="province" class="sel" onclick="openCitySelector()" tapmode>
								<!--{{= curCity.province.name || '&nbsp;'}}-->&nbsp;
							</div>
						</div>
					</div>
					<div class="flex-1 " style="margin-left: 15px;">
						<div class="text" lan="PostalCode">Postal Code</div>
						<!-- L3R9P1 -->
						<div><input type="text" placeholder="" id="postalCode" value="" oninput="postalcodeInput(event,this)" /></div>
					</div>
				</div>
				<div class="flex-box flex-h-ce"style="height: 30px;">
					<div class="flex-1 card" lan="SaveCardDetails">Save Card Details</div>
					<div class="btn-card" onclick="saveCard(this)" tapmode=""></div>
				</div>
				<div class="copy" style="padding-bottom: 20px;margin-top: 60px;">
					<div class="cirlce"></div>
					<div class="bom-t" lan="">
					  Afavor will maintain the confidentiality<br />
						 of your information</div>
				</div>
				<div class="foot" id="footer">
					<div class="save btn-afavor-1" onclick="save()" lan="MAKE_A_PAYMENT" tapmode>MAKE A PAYMENT</div>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/doT.min.js"></script>
	<script type="text/javascript" src="../../script/common.js"></script>
	<script type="text/javascript" src="../../script/area.js"></script>
	<script src="../../script/jquery-1.9.1.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="../../script/UiActionSelector.js"></script>
	<script type="text/javascript" src="../../script/rongCloud2.js" ></script>
	<script type="text/javascript" src="../../script/rongCloud_ps.js" ></script>
	<script type="text/javascript" src="../../res/language.js" ></script>
	
	<script type="text/javascript">

		function postalcodeInput(e, _this) {
			var _val = $api.val(_this);
			if(!/^[A-Z0-9]{0,6}$/.test(_val)){
				if(_val.length > 6){
					$api.val(_this, _val.slice(0, 6));
					//将键盘收起
					_this.blur();
				}else{
					Tool.toast('Postal code can only type capital letters or Numbers.');
				}
			}
		}
	    var initBodyHeight = document.body.clientHeight;//页面可视高度
		var keyBoardStatus = false;//键盘是否打开
	    function getKeyBoardStatus(){
	  		setTimeout(function(){
	        if(initBodyHeight != document.body.clientHeight && keyBoardStatus == false){
	          keyBoardStatus = true;
				$api.addCls($api.dom('#footer'), 'hidden');
	          getKeyBoardStatus();
	          return false;
	        }
	        if(initBodyHeight == document.body.clientHeight && keyBoardStatus == true){
	          keyBoardStatus = false;
				$api.removeCls($api.dom('#footer'), 'hidden');
	          getKeyBoardStatus();
	          return false;
	        }
	        getKeyBoardStatus();
	      },100);
	    }
		
		apiready = function() {
			api.addEventListener({
				name: 'cardReader'
			}, function(ret, err) {
				if(ret.value.cardNum) {
					$api.val($api.dom('#number'), ret.value.cardNum);
				}
				if(ret.value.expiryMonth && ret.value.expirtyYear) {
					$api.val($api.dom('#expire'), ret.value.expirtyYear + '-' + ret.value.expiryMonth);
				}
				if(ret.value.cvv) {
					$api.val($api.dom('#securityCode'), ret.value.cvv);
				}
			});
			L.init();
		}
		var curCity = {
			country: {},
			province: {},
			city: {}
		};
        var isdefault=2
		function saveCard(_this) {
			if($api.hasCls($api.dom('.btn-card'), 'btn-card')) {
				//关闭后仅做一次消费使用
				$api.addCls(_this, 'btn-card-close');
				$api.removeCls(_this, 'btn-card');
				isdefault = 1;
			} else {
				$api.addCls(_this, 'btn-card');
				$api.removeCls(_this, 'btn-card-close');
				isdefault = 2;
			}
		}

		function save() {
			var name = $api.val($api.dom('#name')),
				number = $api.val($api.dom('#number')),
				expire = $api.val($api.dom('#expire')),
				securitycode = $api.val($api.dom('#securityCode')),
				address = $api.val($api.dom('#address')),
				city = curCity.city.value || '',
				province = curCity.province.value || '',
				country = curCity.country.value || '',
			postalcode = $api.val($api.dom('#postalCode'));
			var exp = expire.split('-', 2);
			expire = exp[1] + '-' + exp[0];
			var expYear = parseInt(exp[0]);
			var expMonth = parseInt(exp[1]);
			if(!name) {
				Tool.toast('Please complete all information.');
				return;
			}
			if(!number) {
				Tool.toast('Please complete all information.');
				return;
			}
			if(!expire) {
				Tool.toast('Please complete all information.');
				return;
			}
			if(!securitycode) {
				Tool.toast('Please complete all information.');
				return;
			}
			if(!city) {
				Tool.toast('Please complete all information.');
				return;
			}
			if(!address) {
				Tool.toast('Please complete all information.');
				return;
			}
			if(!province) {
				Tool.toast('Please complete all information.');
				return;
			}
			if(!postalcode) {
				Tool.toast('Please complete all information.');
				return;
			}
			if(!/^[A-Z0-9]{6,20}$/.test(postalcode)) {
				Tool.toast('Postal code can only type capital letters and Numbers.');
				return;
			}
			var values = {
				id: $api.getStorage(CONFIG.KEY.MEMBER_ID),
				token: $api.getStorage(CONFIG.KEY.TOKEN),
				type: 1,
				name: name,
				number: number,
				expiredate: expire,
				securitycode: securitycode,
				street: address,
				city: city,
				privince: province,
				country: country,
				postalcode: postalcode,
				isdefault:isdefault
			}
			api.showProgress({
				title: 'Loading...',
				text: 'Please wait...',
				modal: true
			});
			var stripePay = api.require('stripePay');
			stripePay.getToken({
				cvc: securitycode,
				expMonth: expMonth,
				expYear: expYear,
				number: number
			}, function(ret, err) {
				if(ret.status) {
					if(ret.token.details.funding != 'credit'){
						var tip = 'It is not a credit card.Please try again.';
						Tool.toast(tip);
						api.hideProgress();
						return;
					}
					
					//alert(JSON.stringify(ret))
					ajax.get({
						ctrl: 'more',
						fn: 'addPayments',
						data: {
							values: values
						},
						hideLoading: true,
						showError: true,
						showProgress: true,
						success: function(ct) {
//							Tool.toast('Added Successfully.');

//							api.execScript({	//旧的支付页面，暂弃用，2018-01-20
//								name: 'PaymentMethod',
//								frameName: 'make_payments',
//								script: 'init()'
//							});
							
							api.execScript({	//新支付页面
								name: 'Make_A_Payment',
								frameName: 'make_a_payment',
								script: 'getCreditList()'
							});
							
							creditCardPay(ct.pid);
						}
					});
					console.log(JSON.stringify(ret, null, 2))
				} else {
					api.hideProgress();
					try {
						Tool.toast(JSON.parse(err.msg).NSLocalizedDescription)
					} catch(e) {
						Tool.toast(err.msg)
					}
					console.log(JSON.stringify(err))
				}
			});
		}
		
		function getCreditCardId(number){
			/*
			 * 匹配已添加的信用卡id
			 */
        	ajax.get({
				ctrl: 'more',
				fn: 'getPayments',
				data: {
					values: {
						id: $api.getStorage(CONFIG.KEY.MEMBER_ID),
						token: $api.getStorage(CONFIG.KEY.TOKEN),
						type: 1
					}
				},
				hideLoading: true,
				success: function(ct) {
		            var cardId;
		            ct.some(function(value, index){
		            	if(value.number == number){
		            		cardId = value.id;
		            		return true;
		            	}
		            });
					
					if(cardId){
						creditCardPay(cardId);
					}else{
						Tool.toast('Pay fail!');
					}
				}
			});			
		}
		
		function creditCardPay(cardId){
			/*
			 * 信用卡支付
			 */
			ajax.get({
				ctrl: 'post',
				fn: 'creditPay',
				hideLoading: true,
				data: {
					values: {
						id: $api.getStorage(CONFIG.KEY.MEMBER_ID),
						token: $api.getStorage(CONFIG.KEY.TOKEN),
						afavorid: api.pageParam.favorId,
						cardid: cardId
					}
				},
				showProgress: true,
				success: function() {
					api.execScript({
						name: 'task_detail',
						frameName: 'my_task_detail',
						script: 'init()'
					});	
					
					if(api.pageParam.workers > 1){
						//多人任务，支付后，加入群聊
						RongCloud2.joinChat({
							favorId: api.pageParam.favorId
						});
					}	
					
					api.alert({
						msg: 'You have successfully make the payment, and you favor is ready to go.',
						buttons: ['OK']
					}, function(ret){
						api.closeToWin({
							name: 'task_detail'
						});
					});
				},
				_404: function(msg){
					Tool.toast(msg);
				}
			});			
		}
	</script>

</html>