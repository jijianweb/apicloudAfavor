<!doctype html>
<html lang="en">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no">
		<title>个人主页-帮助者-编辑资料</title>
		<link rel="stylesheet" type="text/css" href="../../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../../css/ct.css" />
		<style type="text/css">
			#main {
				padding: 0px 18px;
			}


			input[type="date"],
			input[type="text"],
			input[type="number"],
			.value_text {
				-webkit-appearance: none;
				outline: none;
				resize: none;
				border: 1px solid #CCCCCC;
				border-radius: 25px;
				font-size: 14px;
				color: #000000;
				width: 100%;
			}

			.sel-bor {
				border: 1px solid #CCCCCC;
				border-radius: 25px;
				width: 100%;
				padding:0px 22px;
				font-size: 14px;
				}

			.sel {
				color: #000000;
				background: red;
				outline: none;
				resize: none;
				padding: 14px 0px 13px;
				font-size: 14px;
				border: none;
				appearance: none;
				-moz-appearance: none;
				-webkit-appearance: none;
				background: url(../../image/down.png)no-repeat scroll right center transparent;
				background-size: 13px 8px;
			}

			input[type="date"]::-webkit-calendar-picker-indicator {
				-webkit-appearance: none!important;
				-moz-appearance: none !important;
				appearance: none !important;
				margin: 0;
				visibility: hidden;
				position: relative;
				opacity: 0 !important;
				z-index: 998;
				display: none !important;
				color: #000000;
			}

			.square {
				background-position: center;
				background-image: url(../../image/post/xiala.png);
				background-size: 13px auto;
				background-repeat: no-repeat;
				width: 12px;
				height:12px;
				margin-right: 0px;
				padding: 20px 10px 15px 10px;
			}

			.date {
				border: 1px solid #D3D4D5;
				border-radius: 25px;
				width: 100%;
				padding: 4px 22px;
			}

			input[type='date'] {
			    color: #000000;
				-webkit-appearance: none;
				border: none;
			}

			input[type="text"],
			input[type="number"],
			.value_text {
				padding: 13px 22px;

			}

			.text {
				color: #858B8B;
				font-size: 14px;
				padding: 0 0 9px 23px;
			}
			.save {
				background-color: #32BBB1;
				border-radius: 25px;
				text-align: center;
				color: white;
				margin-top:40px;
				position: relative;
				bottom:16px;
			}
			.avatar {
				position: relative;
				overflow: hidden;
				width: 100px;
				height: 100px;
				background: no-repeat center;
				background-color: #B4B8BB;
				background-size: cover;
				border-radius: 50%;
				margin-top: 32px;
			}

			.area {
				border: 1px solid #D3D4D5;
				background-color: white;
				border-radius: 8px;
				height: 150px;
				width: 100%;
				padding: 15px;
			}

			textarea {
				outline: none;
				resize: none;
				width: 100%;
				font-family: "微软雅黑";
				color: #000000;
				height: 120px;
				margin-bottom: 20px;
			}

			.se {
				margin-bottom: 15px;
			}

			.avatar-box{
				height: 112px;
				width: 100%;
			}
			.img-frm,
			.img {
				width: 100%;
				height: 100%;
			}
		</style>
	</head>

	<body>
		<div id="wrap">
			<div id="main">
				<div class="avatar-box flex-box flex-center-center">
					<div class="avatar">
					</div>
				</div>
				<div class="margin-top30 ">
						<div class="flex-box se">
						<div class="flex-1">
							<div class="text">First name</div>
							<input type="text" />
						</div>
						<div class="flex-1" style="margin-left: 15px;">
							<div class="text">Last name</div>
							<input type="text" />
						</div>
					</div>
					<div class="se">
						<span class="text">Email</span>
						<input type="text" placeholder="" />
					</div>
					<div class="se">
						<span class="text">Birthday</span>
						<div class="date flex-box flex-center-center">
							<input class="flex-1" type="date" />
							<span class="square"></span>
						</div>
					</div>
					<div class="se">
						<span class="text">Street Address</span>
						<input type="text" />
					</div>
					<div class="se">
						<span class="text">City</span>
						<input type="text" placeholder="" />
					</div>
					<div class="flex-box se">
						<div class="flex-1">
							<div class="text">Province</div>
							<div class="sel-bor">
								<div id="province" class="sel" >
									province
								</div>
							</div>
						</div>
						<div class="flex-1 " style="margin-left: 15px;">
							<div class="text">Postal Code</div>
							<div><input type="number" placeholder="" /></div>
						</div>
					</div>
					<div class="se">
						<span class="text">Skill</span>
						<input type="text" placeholder="" />
					</div>
					<span class="text">About</span>
					<div class="area">
						<textarea name="" rows="8"></textarea>
					</div>
				</div>
				<div id="footer">
					<div class="save" onclick="save()" tapmode="">SAVE</div>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/doT.min.js"></script>
	<script type="text/javascript" src="../../script/common.js"></script>
	<script type="text/javascript" src="../../script/upload.js" ></script>
	<script type="text/javascript" src="../../script/UiActionSelector.js" ></script>
	<script type="text/javascript" src="../../script/area.js" ></script>
	<script src="../../script/jquery-1.9.1.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="../../res/language.js" ></script>
	<script type="text/template" template="main">
		<div class="avatar-box flex-box flex-center-center">
			<div class="avatar" imgUrl="{{= it.avatar}}" data-status="done" data-key="" data-callbackEvent="uploadAvatar" onclick="uploadAvatar()" tapmode="">
				<div class="img-frm">
					<div class="img" style="background-image: url({{= Tool.imageCompressByQiNiu(it.avatar,0,200,200)}});">
					</div>
				</div>
			</div>
		</div>
		<div class="margin-top30">
			<div class="flex-box se">
				<div class="flex-1">
					<div class="text" lan="First_name">First name</div>
					<input type="text" value="{{=it.firstname || ''}}" id="firstname" />
			    </div>
				<div class="flex-1" style="margin-left: 15px;">
						<div class="text" lan="Last_name">Last name</div>
						<input type="text" value="{{=it.lastname || ''}}" id="lastname" />
				</div>
			</div>
			<div class="se">
				<span class="text" lan="Email">Email</span>
				<input type="text" placeholder="" value="{{=it.email || ''}}" id="email" />
			</div>
			<div class="se">
				<span class="text" lan="Birthday">Birthday</span>
				<div class="date flex-box flex-center-center">
					<input class="flex-1" type="date" placeholder="" value="{{=it.birthday || ''}}"  id="birthday" />
					<span class="square"></span>
				</div>
			</div>
			<div class="se">
				<span class="text" lan="StreetAddress">Street Address</span>
				<input id="street" type="text" value="{{=it.street}}" />
			</div>
			<div class="se">
				<span class="text" lan="City">City</span>
				<div id="city" class="value_text" onclick="openCitySelector()" tapmode>
					{{= curCity.city.name || '&nbsp;'}}
				</div>
			</div>
			<div class="flex-box se">
				<div class="flex-1">
					<div class="text" lan="Province">Province</div>
					<div class="sel-bor">
						<div id="province" class="sel" onclick="openCitySelector()" tapmode >
							{{= curCity.province.name || '&nbsp;'}}
						</div>
					</div>
				</div>
				<div class="flex-1 " style="margin-left: 15px;">
					<div class="text" lan="PostalCode">Postal Code</div>
					<div><input type="text" placeholder="" value="{{=it.postalcode || ''}}" id="postalcode" oninput="postalcodeInput(event,this)" /></div>
				</div>
			</div>
			<div class="se">
				<span class="text" lan="Skills">Skills</span>
				<input type="text" placeholder="" value="{{=it.skills || ''}}" id="skills" />
			</div>
			<span class="text" lan="About">About</span>
			<div class="area">
				<textarea name="" rows="8" id="about">{{=it.about || ''}}</textarea>
			</div>
			<div id="footer">
					<div class="save btn-afavor-1" lan="SAVE" onclick="save()" tapmode="">SAVE</div>
			</div>
		</div>
	</script>
	<script type="text/template" template="img">
		<div class="avatar" imgUrl="{{= it.url}}" data-status="" data-key="" data-callbackEvent="{{= it.callbackEvent}}" onclick="uploadAvatar()" tapmode="">
			<div class="img-frm">
				<div class="img" style="background-image:url({{= Tool.imageCompressByQiNiu(= it.url,0,200,200)}})">
					<div class="upload-status flex-box " style="background-color: rgba(209,209,209,0.5);font-size: 11px;">
						<div class=" flex-1 status"></div>
					</div>
				</div>
			</div>
		</div>
	</script>
    <script type="text/javascript">

		function postalcodeInput(e,_this){
			var _val = $api.val(_this);
			if(!/^[A-Z0-9]{0,6}$/.test(_val)){
				if(_val.length > 6){
					$api.val(_this, _val.slice(0, 6));
					//将键盘收起
					_this.blur();
				}else{
					Tool.toast('Postal code can only type capital letters or Numbers.');
				}
			}
		}
		var curCity = {
			country: {},
			province: {},
			city: {}
		};

		var params_1;	//对象类型,记录页面初始化时的数据

		apiready = function() {
			// init();
			$api.css($api.dom("input[type='date']"),'padding:8px 0 8px 15px;')
            api.addEventListener({
				name: 'file_upload'
			},function(ret){
				if(ret && ret.value){
					var value = ret.value;
					if(value._key){
						$api.css($api.dom('.img'),'background-image: url('+value.imagePath+')');
					    $api.attr($api.dom('[data-key]'),"data-key",value._key);
						setTimeout(function(){
							api.closeToWin({
							    name: api.winName
							});
						},300)
					}
				}
			})
		}

		function closeWin(){
			var params_2 = getParam();

			if(JSON.stringify(params_1) != JSON.stringify(params_2)){
				api.confirm({
					title: 'The modified information is not saved. Do you want to exit?',
					buttons: ['No', 'Yes']
				}, function(ret, err) {
					if(ret.buttonIndex == 2) {
						api.closeWin();
					}
				})
			}else{
				api.closeWin();
			}
		}

		var lastData = {};
		var url_avatar=''
		function init() {
			ajax.get({
				ctrl: 'more',
				fn: 'getMyInfo',
				data: {
					values: {
						id: $api.getStorage(CONFIG.KEY.MEMBER_ID),
						token: $api.getStorage(CONFIG.KEY.TOKEN)
					}
				},
				showError: true,
				success: function(ct) {
					lastData = ct;
					curCity = Area.getCityName(ct.country,ct.province,ct.city)
					T.html('#main', 'main', ct);
					params_1 = getParam();
					url_avatar=ct.avatar
//                  alert(url_avatar);
					L.init();
				}
			});
		}
		function uploadAvatar() {
			api.openWin({
				name: 'takePic',
				url: api.wgtRootDir + '/html/window/verify/black_close_win.html',
				pageParam:{
					headerTitle: 'Profile Photo',
					frameName: 'personal_cam',
					frameUrl: api.wgtRootDir + '/html/component/personal_cam.html',
					frameParam:{
						type: 1,
					}
				},
				slidBackEnabled: false,
			})

		}
//		function renderImg(args) {
//			T.html('.avatar-box', 'img', args)
//		}

		function getParam(){
			var params = {
				avatar: $api.attr($api.dom('[data-key]'),'data-key'),
				firstname: $api.val($api.dom('#firstname')),
				lastname: $api.val($api.dom('#lastname')),
				email: $api.val($api.dom('#email')),
				birthday: $api.val($api.dom('#birthday')),
				street: $api.val($api.dom('#street')),
				postalcode: $api.val($api.dom('#postalcode')),
				skills: $api.val($api.dom('#skills')),
				about: $api.val($api.dom('#about')),
				city: curCity.city.value,
				province: curCity.province.value,
				country: curCity.country.value
			};

			return params;
		}

		function save() {
//			var is_uploaded = $api.attr($api.dom('[data-status]'),'data-status') == 'done';
//			if(!is_uploaded){
//				Tool.toast('Please upload your avatar');
//				return ;
//			}
			var avatar = $api.attr($api.dom('[data-key]'),'data-key'),
			    firstname = $api.val($api.dom('#firstname')),
				lastname = $api.val($api.dom('#lastname')),
				email = $api.val($api.dom('#email')),
				birthday = $api.val($api.dom('#birthday')),
				street = $api.val($api.dom('#street')),
				postalcode = $api.val($api.dom('#postalcode')),
				skills = $api.val($api.dom('#skills')),
				about = $api.val($api.dom('#about'));
			if(postalcode && !/^[A-Z0-9]{6,20}$/.test(postalcode)) {
				Tool.toast('Postal code can only type capital letters or Numbers.');
				return;
			}

//			if((url_avatar==avatar && url_avatar!='')|| avatar==''){
//				avatar=picPath(url_avatar);
//				alert(1)
//			}else if(url_avatar!=avatar && avatar!=''){
//				avatar = $api.attr($api.dom('[data-key]'),'data-key');
//			}
			var _url='http://osiq15wvv.bkt.gdipper.com/'
			var values = {
				id: $api.getStorage(CONFIG.KEY.MEMBER_ID),
				token: $api.getStorage(CONFIG.KEY.TOKEN),
				avatar: avatar=='' ? picPath(url_avatar) : avatar ,
				firstname: firstname,
				lastname: lastname,
				email: email,
				birthday: birthday,
				street: street,
				city: curCity.city.value,
				province: curCity.province.value,
				country: curCity.country.value,
				postalcode: postalcode,
				skills: skills,
				about: about
			}

            ajax.get({
				ctrl: 'more',
				fn: 'editMyInfo',
				data: {
					values: values
				},
				showProgress: true,
				hideLoading: true,
				showError: true,
				success: function() {
					Tool.toast('Edit Successfully.')
					api.sendEvent({
						name: 'editMemberInfo',
						extra: {
							name: firstname+' '+lastname
						}
					})
					setTimeout(api.closeWin,300);
				},
				_404: function(){
					api.closeWin()
				}
			});

		}
	</script>

</html>
